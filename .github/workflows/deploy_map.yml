name: Auto Build Map

on:
  push:
    branches:
      - main
    paths:
      - '**.xlsx'
      - '**.py'
      - 'requirements.txt'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è¼‰å°ˆæ¡ˆ (Checkout)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # æŠ“å–å®Œæ•´æ­·å²ï¼Œé€™å¾ˆé‡è¦

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£å¥—ä»¶
        run: |
          pip install -r requirements.txt

      - name: åŸ·è¡Œè£½åœ–ç¨‹å¼
        run: |
          # é€™è£¡è¦ç¢ºèªä½ çš„ python æª”åæ˜¯å¦æ­£ç¢ºï¼Œå¦‚æœä¸ä¸€æ¨£è«‹æ‰‹å‹•ä¿®æ”¹
          python build_map.py

      - name: ç™¼å¸ƒèˆ‡åŒæ­¥ (Deploy)
        run: |
          git config --global user.name "Map Bot"
          git config --global user.email "bot@github.com"
          
          # 1. åŠ å…¥æ‰€æœ‰è®Šæ›´
          git add .
          
          # 2. æª¢æŸ¥æœ‰æ²’æœ‰æ±è¥¿éœ€è¦ä¸Šå‚³ï¼Ÿ(é¿å…ç´…ç‡ˆé—œéµ)
          if [ -z "$(git status --porcelain)" ]; then
            echo "ğŸŸ¢ åµæ¸¬åˆ°æ²’æœ‰æª”æ¡ˆè®Šæ›´ï¼Œè‡ªå‹•çµæŸå·¥ä½œã€‚"
            exit 0
          fi

          # 3. å¦‚æœæœ‰è®Šæ›´ï¼Œæ‰åŸ·è¡Œæäº¤
          echo "ğŸŸ¡ åµæ¸¬åˆ°è®Šæ›´ï¼Œæº–å‚™æäº¤..."
          git commit -m "Auto-update map by Bot"

          # 4. ğŸ”¥ é—œéµï¼šä¸Šå‚³å‰å…ˆè·Ÿé›²ç«¯åŒæ­¥ (è§£æ±ºä½ ç¾åœ¨çš„å ±éŒ¯)
          echo "ğŸ”„ æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥..."
          git pull --rebase origin main
          
          # 5. æ¨é€
          echo "ğŸš€ æ¨é€æ›´æ–°..."
          git push origin main
